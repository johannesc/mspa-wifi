substitutions:
  device_name: mspa
  device_password: !secret mspa_password
  device_api_key: !secret mspa_api_key

esphome:
  name: ${device_name}

esp32:
  board: lolin_s2_mini
  variant: esp32s2
  framework:
    type: esp-idf

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "esp-${device_name}"
    password: "${device_password}"

captive_portal:

# Enable logging
logger:
  level: INFO  # Set to DEBUG if you are having issues!
  #baud_rate: 0 # disable logging over uart

api:
  encryption:
    key: "${device_api_key}"

ota:
  platform: esphome
  password: "${device_password}"

web_server:
  port: 80
  ota: false
#  auth:
#    username: admin
#    password: "${device_password}"

external_components:
  - source: components
    components: [ mspa_wifi ]

uart:
  - id: uart_box_to_remote
    rx_pin: # green cable to box
      number: GPIO33
      inverted: false
    tx_pin: # green cable to remote
      number: GPIO39
      inverted: false
    baud_rate: 9600
    rx_buffer_size: 512
  - id: uart_remote_to_box
    rx_pin: # black cable to remote
      number: GPIO37
      inverted: false
    tx_pin: # black cable to box
      number: GPIO18
      inverted: false
    baud_rate: 9600
    rx_buffer_size: 512

mspa_wifi:
  id: mspa_wifi_1
  uart_box_to_remote_id: uart_box_to_remote
  uart_remote_to_box_id: uart_remote_to_box
  uvc_command: 0x15

  # Sensors
  water_temperature:
    id: mspa_water_temperature
    name: "Temperature"
    state_class: "measurement"
    unit_of_measurement: "Â°C"
    device_class: "temperature"
    accuracy_decimals: 1

  # Binary sensors
  flow_in:
    name: "Flow In"
  flow_out:
    name: "Flow Out"

  # Switches
  filter_pump:
    name: "Filter Pump"
    on_turn_off:
      climate.control:
        id: climate_thermostat
        mode: "OFF"

  uvc:
    name: "UVC"
  ozone:
    name: "Ozone"
  heater:
    id: mspa_heater
    name: "Heater"

  # Number controls
  target_water_temperature:
    name: "Target Temperature"
    id: mpsa_target_temperature
    min_value: 20

  bubble_speed:
    name: "Bubble Speed"
    max_value: 3

sensor:
  - platform: uptime
    type: seconds
    name: Uptime Sensor
  - platform: internal_temperature
    name: "Internal Temperature"
    id: int_temp

climate:
  - platform: thermostat
    name: "Pool Controller"
    id: climate_thermostat
    sensor: mspa_water_temperature
    min_heating_off_time: 10s
    min_heating_run_time: 10s
    min_idle_time: 10s
    visual:
      min_temperature: 20
      max_temperature: 40
      temperature_step: 0.5
    heat_action:
      - switch.turn_on: mspa_heater
    idle_action:
      - switch.turn_off: mspa_heater
    default_preset: Standby
    preset:
      - name: Standby
        default_target_temperature_low: 30
      - name: Swim
        default_target_temperature_low: 40
    on_state:
      - lambda: |-
          id(mpsa_target_temperature).control(x.target_temperature);
